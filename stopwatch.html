<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Stopwatch</title>
  <style>
    :root {
      --bg: #1c1f2a;
      --panel: #2b2f3a;
      --text: #ffffff;
      --muted: #b0b7c3;
      --accent: #ff6b6b;   /* coral */
      --accent-2: #4ecdc4; /* teal */
      --danger: #ff4f81;   /* pink */
      --shadow: rgba(0,0,0,.4);
    }
    @media (prefers-color-scheme: light) {
      :root { --bg: #f3f5f9; --panel: #ffffff; --text: #1c1f2a; --muted:#5b6b7b; --shadow: rgba(0,0,0,.1); }
    }
    * { box-sizing: border-box }
    body {
      margin: 0; font-family: 'Segoe UI', ui-sans-serif, system-ui, -apple-system, Roboto, Helvetica, Arial;
      background: radial-gradient(1000px 600px at 80% -10%, rgba(255,107,107,.2), transparent 60%),
                  radial-gradient(900px 500px at -10% 110%, rgba(78,205,196,.2), transparent 55%),
                  var(--bg);
      color: var(--text);
      min-height: 100svh;
      display: grid; place-items: center;
      padding: 24px;
    }
    .card {
      width: 100%; max-width: 760px; background: var(--panel);
      border-radius: 24px; box-shadow: 0 20px 50px var(--shadow);
      padding: clamp(20px, 4vw, 32px);
      border: 1px solid rgba(255,255,255,.08);
    }
    h1 { margin: 0 0 8px; font-size: clamp(20px, 2.4vw, 28px); font-weight: 700; letter-spacing: .2px; }
    .sub { color: var(--muted); font-size: 14px; margin-bottom: 24px }

    .display {
      font-variant-numeric: tabular-nums; font-feature-settings: "tnum";
      display: flex; align-items: baseline; gap: 12px; justify-content: center;
      padding: 18px 14px; margin: 6px 0 18px; border-radius: 18px;
      background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.03));
      border: 1px solid rgba(255,255,255,.1);
    }
    .time { font-size: clamp(40px, 9vw, 80px); font-weight: 800; letter-spacing: 1px; color: var(--accent-2); }
    .ms { font-size: clamp(16px, 2.5vw, 22px); color: var(--accent); margin-left: 4px; }

    .controls { display: grid; grid-template-columns: repeat(3, minmax(0,1fr)); gap: 12px; margin: 8px 0 4px }
    button {
      appearance: none; border: none; cursor: pointer; border-radius: 14px; padding: 14px 16px; font-weight: 700;
      transition: transform .02s ease, filter .2s ease;
      background: #333b4f; color: var(--text); border: 1px solid rgba(255,255,255,.1);
      box-shadow: inset 0 1px 0 rgba(255,255,255,.05), 0 8px 18px var(--shadow);
    }
    button:hover { filter: brightness(1.1) }
    button:active { transform: translateY(1px) }
    .primary { background: linear-gradient(180deg, rgba(255,107,107,1), rgba(255,107,107,.8)); }
    .success { background: linear-gradient(180deg, rgba(78,205,196,1), rgba(78,205,196,.8)); }
    .danger { background: linear-gradient(180deg, rgba(255,79,129,1), rgba(255,79,129,.8)); }
    button[disabled] { opacity: .5; cursor: not-allowed; }

    .hotkeys { color: var(--muted); font-size: 12px; text-align: center; margin-top: 6px }

    .laps {
      margin-top: 18px; border: 1px solid rgba(255,255,255,.1); border-radius: 14px; overflow: hidden;
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
    }
    .laps header { display: flex; justify-content: space-between; align-items: center; padding: 12px 14px; }
    .laps h2 { margin: 0; font-size: 14px; letter-spacing: .3px; text-transform: uppercase; color: var(--muted) }
    .lap-actions { display: flex; gap: 8px }
    .lap-actions button { padding: 8px 10px; border-radius: 10px; font-weight: 600; font-size: 12px }
    table { width: 100%; border-collapse: collapse; table-layout: fixed; }
    th, td { text-align: right; padding: 10px 12px; border-top: 1px dashed rgba(255,255,255,.1); font-variant-numeric: tabular-nums }
    th { color: var(--muted); font-weight: 600; text-transform: uppercase; font-size: 12px; letter-spacing: .3px }
    td:first-child, th:first-child { text-align: left }
    .empty { text-align: center; color: var(--muted); padding: 16px }
    .sr-only { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0,0,0,0); white-space: nowrap; border: 0; }
  </style>
</head>
<body>
  <main class="card" role="application" aria-label="Stopwatch application">
    <header>
      <h1>⏱ Stopwatch</h1>
      <div class="sub">Precise to the millisecond. Space = Start/Pause · L = Lap · R = Reset</div>
    </header>

    <section class="display" aria-live="polite" aria-atomic="true">
      <div class="time" id="clock" aria-label="elapsed time">00:00:00</div>
      <div class="ms" id="millis" aria-hidden="true">.000</div>
    </section>

    <div class="controls">
      <button id="startBtn" class="primary" aria-pressed="false" aria-label="Start stopwatch">Start</button>
      <button id="lapBtn" class="success" disabled aria-label="Record lap">Lap</button>
      <button id="resetBtn" class="danger" disabled aria-label="Reset stopwatch">Reset</button>
    </div>
    <div class="hotkeys">Hotkeys: <kbd>Space</kbd> start/pause · <kbd>L</kbd> lap · <kbd>R</kbd> reset</div>

    <section class="laps" aria-label="Lap times">
      <header>
        <h2>Laps</h2>
        <div class="lap-actions">
          <button id="exportBtn" title="Export laps to CSV" disabled>Export CSV</button>
          <button id="clearLapsBtn" title="Clear laps" disabled>Clear</button>
        </div>
      </header>
      <table aria-describedby="lapTableHelp">
        <thead>
          <tr>
            <th>#</th>
            <th>Lap</th>
            <th>Total</th>
            <th>+/- Prev</th>
          </tr>
        </thead>
        <tbody id="lapBody">
          <tr class="empty"><td colspan="4">No laps yet</td></tr>
        </tbody>
      </table>
      <p id="lapTableHelp" class="sr-only">Lap shows the duration of the lap. Total shows overall elapsed time when the lap was taken. Plus/minus shows the difference from the previous lap.</p>
    </section>
  </main>

  <script>
    (function(){
      const clock = document.getElementById('clock');
      const millis = document.getElementById('millis');
      const startBtn = document.getElementById('startBtn');
      const lapBtn = document.getElementById('lapBtn');
      const resetBtn = document.getElementById('resetBtn');
      const lapBody = document.getElementById('lapBody');
      const exportBtn = document.getElementById('exportBtn');
      const clearLapsBtn = document.getElementById('clearLapsBtn');

      let running = false;
      let startTime = 0;      // performance.now() when started
      let elapsed = 0;        // accumulated ms while paused
      let rafId = null;
      let laps = [];          // { totalMs, lapMs }

      function pad(n, w=2){ return String(n).padStart(w, '0'); }
      function format(ms){
        const hours = Math.floor(ms / 3600000);
        const minutes = Math.floor((ms % 3600000) / 60000);
        const seconds = Math.floor((ms % 60000) / 1000);
        const milliseconds = Math.floor(ms % 1000);
        return {
         hms: `${pad(hours)}:${pad(minutes)}:${pad(seconds)}`,
ms: `.${pad(milliseconds, 3)}`

        };
      }

      function now(){ return performance.now(); }
      function getElapsed(){ return running ? (now() - startTime) : elapsed; }

      function update(){
        const t = getElapsed();
        const f = format(t);
        clock.textContent = f.hms;
        millis.textContent = f.ms;
        if(running){ rafId = requestAnimationFrame(update); }
      }

      function setRunningState(isRunning){
        running = isRunning;
        startBtn.textContent = isRunning ? 'Pause' : (elapsed ? 'Resume' : 'Start');
        startBtn.setAttribute('aria-pressed', String(isRunning));
        lapBtn.disabled = !isRunning;
        resetBtn.disabled = !(elapsed || isRunning || laps.length);
      }

      function start(){
        startTime = now() - elapsed;
        setRunningState(true);
        update();
      }

      function pause(){
        elapsed = now() - startTime;
        setRunningState(false);
        if(rafId) cancelAnimationFrame(rafId);
      }

      function reset(){
        if(rafId) cancelAnimationFrame(rafId);
        elapsed = 0; startTime = 0; setRunningState(false);
        renderDisplay(0);
        laps = []; renderLaps();
      }

      function renderDisplay(ms){
        const f = format(ms);
        clock.textContent = f.hms; millis.textContent = f.ms;
      }

      function addLap(){
        const total = getElapsed();
        const prevTotal = laps.length ? laps[laps.length-1].totalMs : 0;
        const lapMs = total - prevTotal;
        laps.push({ totalMs: total, lapMs });
        renderLaps();
        resetBtn.disabled = false;
      }

      function renderLaps(){
        lapBody.innerHTML = '';
        if(!laps.length){
          lapBody.innerHTML = '<tr class="empty"><td colspan="4">No laps yet</td></tr>';
          exportBtn.disabled = true; clearLapsBtn.disabled = true; return;
        }
        exportBtn.disabled = false; clearLapsBtn.disabled = false;
        const avg = laps.reduce((s,l)=>s+l.lapMs,0)/laps.length;
        laps.forEach((l, idx) => {
          const diff = l.lapMs - avg; // relative to average
          const fLap = format(l.lapMs); const fTot = format(l.totalMs);
          const sign = diff === 0 ? '' : (diff > 0 ? '+' : '−');
          const row = document.createElement('tr');
          row.innerHTML = `
            <td>${idx+1}</td>
            <td>${fLap.hms}${fLap.ms}</td>
            <td>${fTot.hms}${fTot.ms}</td>
            <td>${sign}${sign ? format(Math.abs(diff)).hms + format(Math.abs(diff)).ms : ''}</td>
          `;
          lapBody.appendChild(row);
        });
      }

      function exportCSV(){
        const header = ['Lap #','Lap Time','Total Time'];
        const lines = [header.join(',')];
        laps.forEach((l, i)=>{
          const fLap = format(l.lapMs); const fTot = format(l.totalMs);
          [i+1, `${fLap.hms}${fLap.ms}`, `${fTot.hms}${fTot.ms}`].join(',')

        });
        const blob = new Blob([lines.join('\n')], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = 'laps.csv'; a.click();
        URL.revokeObjectURL(url);
      }

      // Event wiring
      startBtn.addEventListener('click', () => running ? pause() : start());
      lapBtn.addEventListener('click', addLap);
      resetBtn.addEventListener('click', reset);
      exportBtn.addEventListener('click', exportCSV);
      clearLapsBtn.addEventListener('click', () => { laps = []; renderLaps(); });

      // Keyboard shortcuts
      window.addEventListener('keydown', (e)=>{
        if (e.target.closest('input, textarea, [contenteditable="true"]')) return; // ignore when typing
        if (e.code === 'Space') { e.preventDefault(); running ? pause() : start(); }
        else if (/^KeyR$/i.test(e.code)) { e.preventDefault(); reset(); }
        else if (/^KeyL$/i.test(e.code)) { e.preventDefault(); if(!lapBtn.disabled) addLap(); }
      });

      // Initialize
      renderDisplay(0);
      setRunningState(false);
    })();
  </script>
</body>
</html>